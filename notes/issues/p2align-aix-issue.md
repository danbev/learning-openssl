## p2align aix64 issue
This issue was discovered when trying to build (statically) OpenSSL 3.0 with
Node.js. 

### Compile error:
```console
05:39:05 Assembler:
05:39:05 ../deps/openssl/config/archs/aix64-gcc/asm_avx2/crypto/bn/ppc64-mont-fixed.s: line 4: Error In Syntax 
05:39:05 gmake[2]: *** [deps/openssl/openssl.target.mk:1132: /home/iojs/build/workspace/node-test-commit-aix/nodes/aix72-ppc64/out/Release/obj.target/openssl/deps/openssl/config/archs/aix64-gcc/asm_avx2/crypto/bn/ppc64-mont-fixed.o] Error 1
05:39:05 gmake[2]: *** Waiting for unfinished jobs....
05:39:05 gmake[1]: *** [Makefile:105: node] Error 2
05:39:05 gmake: *** [Makefile:532: build-ci] Error 2
05:39:05 Build step 'Execute shell' marked build as failure
05:39:05 Performing Post build task...
```

This contents of the line and file it is referring to looks like this:
```assembly
.machine        "any"                                                           
.csect  .text[PR],7                                                                
.align  5                                                                          
.p2align        5,,31
```

This assembly source code file is generated as part of the upgrade process
in Node.js.
```console
$ cd deps/openssl/config
$ make aix64-gcc
```
Running this command will configure OpenSSL for `aix64-gcc` and generate the
sources in:
```console
$ ls -l  archs/aix64-gcc/asm_avx2/crypto/bn/
total 52
-rw-rw-r--. 1 danielbevenius danielbevenius 17861 Jun  1 12:08 bn-ppc.s
-rw-rw-r--. 1 danielbevenius danielbevenius  5189 Jun  1 12:08 ppc64-mont-fixed.s
-rw-rw-r--. 1 danielbevenius danielbevenius 23476 Jun  1 12:08 ppc-mont.s
```
`ppc64-mont-fixed.s` is generated by the OpenSSL perl script
`crypto/bn/asm/ppc64-mont-fixed.pl`:
```console
$ git log --summary      crypto/bn/asm/ppc64-mont-fixed.pl
commit 0d40ca47bd86e74a95c3a2f5fb6c67cdbee93c79
Author: Martin Schwenke <martin@meltin.net>
Date:   Wed Apr 14 14:31:58 2021 +1000

    bn: Add fixed length (n=6), unrolled PPC Montgomery Multiplication
    
    Overall improvement for p384 of ~18% on Power 9, compared to existing
    Power assembling code.  See comment in code for more details.
    
    Multiple unrolled versions could be generated for values other than
    6.  However, for TLS 1.3 the only other ECC algorithms that might use
    Montgomery Multiplication are p256 and p521, but these have custom
    algorithms that don't use Montgomery Multiplication.  Non-ECC
    algorithms are likely to use larger key lengths that won't fit into
    the n <= 10 length limitation of this code.
    
    Signed-off-by: Amitay Isaacs <amitay@ozlabs.org>
    Signed-off-by: Alastair D'Silva <alastair@d-silva.org>
    Signed-off-by: Martin Schwenke <martin@meltin.net>
    
    Reviewed-by: Tomas Mraz <tomas@openssl.org>
    Reviewed-by: Paul Dale <pauli@openssl.org>
    (Merged from https://github.com/openssl/openssl/pull/15175)

 create mode 100755 crypto/bn/asm/ppc64-mont-fixed.pl
```
Notice that this file is quite recent and this might mean that this issue is
not something that we run into before.

On the system in question the GNU Assembler (GAS) is not used, instead the
assembler is 

```assembly
$ cat test.s
.machine        "any"                                                           
.csect  .text[PR],7        ;; csect=Control Section, PR=Program Code, 7=alignment(2‚Å∑=128)
.align  5                                                                       
.p2align        5,,31                                                           
                                                                                
.globl  .bn_mul_mont_fixed_n6                                                   
.bn_mul_mont_fixed_n6:
        mr      9,3                                                             
                                                                                
        mtvsrd  32,14                                                           
        mtvsrd  33,15                                                           
        mtvsrd  34,20   
```
```console
as -v test.s
as V7.2
Assembler:
test.s: line 4: Error In Syntax 
```
Notice that this Assembler is not amoung the ones assembler versions mentioned
to be [supported](https://github.com/openssl/openssl/blob/master/INSTALL.md#notes-on-assembler-modules-compilation).

Is it important for us Red Hat/IBM to be able to build using the default
Assembler of could we make GAS a prerequisite perhaps?  
After asking around at work apparently there have been issues with GAS on aix
and this is the reason for preferring AIX Assembler (as). It is about installing
GAS and get on with it which I thought. The current idea we have at the moment
is to either add a configuration flag to OpenSSL Configure or perhaps add a
new arch like aix64-gcc-as which would hopefully enable us to add a check in
the perl script which generates the source file. We also need to make sure that
the alignment is correct as the aix version will not be able to have the
p2align directive.

We can enable warnings to be reported using `-w`:
```console
as -w -v test.s
as V7.2
Assembler:
test.s: line 3: Warning - The alignment of the current csect is
                less than the alignment specified with the .align pseudo-op.
test.s: line 4: Error In Syntax 
```

Compile Node.js on aix:
```console
$ export PATH=/opt/ccache-3.7.4/libexec:/opt/freeware/bin:/usr/bin:/etc:/usr/sbin:/usr/ucb:/home/iojs/bin:/usr/bin/X11:/sbin:.
$ export CC=gcc CXX=g++ CXX_host=g++
$ ./configure --verbose  --dest-cpu=ppc64
$ gmake -C out BUILDTYPE=Release V=0
```
Commenting out the .p2align diretive enable the build to pass successfully.

When we configure OpenSSL specifiying the arch as `aix64-gcc`:
```console
$ ./Configure aix64-gcc
```
Lets take a look at the recipe for crypto/bn/ppc64-mont-fixed:
```console
$ make -n crypto/bn/ppc64-mont-fixed.s
CC="gcc" /usr/bin/perl crypto/bn/asm/ppc64-mont-fixed.pl "aix64" -I. -Iinclude -Iproviders/common/include -Iproviders/implementations/include -maix64 -pthread -Wa,--noexecstack -O --help -DB_ENDIAN -DOPENSSL_PIC -DOPENSSLDIR="\"/usr/local/ssl\"" -DENGINESDIR="\"/usr/local/lib/engines-3\"" -DMODULESDIR="\"/usr/local/lib/ossl-modules\"" -DOPENSSL_BUILDING_OPENSSL -DNDEBUG  -DAES_ASM -DECP_NISTP521_ASM -DECP_NISTZ256_ASM -DKECCAK1600_ASM -DOPENSSL_BN_ASM_MONT -DOPENSSL_CPUID_OBJ -DPOLY1305_ASM -DSHA1_ASM -DSHA256_ASM -DSHA512_ASM -DVPAES_ASM -DX25519_ASM  crypto/bn/ppc64-mont-fixed.s
```
Running this will generate crypto/bn/ppc64-mont-fixed.s.
Looking at the command we can see that the make recipe is calling the perl
script and passing in `aix64`

When crypto/bn/asm/ppc64-mont-fixed.pl is called it will generate the assembler
code and in the process the .p2align directive is added. This directive is
not available in the AIX assembler hence the error we are seeing. A suggestion
is to add an achitecture to OpenSSL's configuration named something like
`aix64-gcc-as' which is supposed to specify that one want to use the AIX
as Assembler and not GAS (gas).

For this a callback could be added to crypto/perlasm/ppc-xlate.pl which check
if the architecture is aix64-as and remove this directive:
```perl
  my $p2align = sub {                                                             
      my $ret = ($flavour =~ /aix64-as/) ? "" : ".p2align $line";                 
      $ret;                                                                       
  }; 
```
This [pull request](https://github.com/openssl/openssl/pull/15638) contains a
suggestion and can be tested manually using the following commands:
```console
$ ./Configure aix64-gcc-as
$ make -B crypto/bn/ppc64-mont-fixed.s
```

__work in progress__
